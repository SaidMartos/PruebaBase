<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kallpa 3D - Registro de Turistas</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* BASE DE SITE.CSS */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f0f0f0; 
            background-image: url('img/plaza-de-armas-cajamarca.jpg');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            background-attachment: fixed;
            position: relative; 
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
            z-index: 0;
        }

        /* ESTILOS DEL CONTENEDOR PRINCIPAL (registro_turistas.css) */
        .container-box {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 450px;
            box-sizing: border-box;
            position: relative; 
            margin: auto;
            z-index: 1;
        }

        h2 {
            font-family: 'Inter', sans-serif;
            font-weight: 800;
            text-align: center;
            margin-bottom: 25px;
            color: #dc3545;
            font-size: 2rem;
            text-transform: uppercase;
        }

        /* Estilos de los grupos de formulario */
        .form-group {
            margin-bottom: 18px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            color: #333;
            font-size: 1rem;
        }
        
        /* Estilos de los campos de entrada y selecci√≥n */
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #ddd;
            border-radius: 10px;
            box-sizing: border-box;
            font-size: 1.1rem;
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-control:focus {
            border-color: #dc3545;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
            outline: none;
        }

        .form-control::placeholder {
            color: #aaa;
        }
        
        /* Estilos para los botones */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.1s ease;
            font-family: 'Inter', sans-serif; 
            margin-top: 10px; /* A√±adido para separaci√≥n entre botones */
        }

        .btn:active {
            transform: translateY(1px);
        }
        
        /* Bot√≥n de limpiar */
        .btn-clear {
            background-color: #6c757d;
            color: white;
            width: 48%;
            margin-top: 0; /* Lo reseteamos para los botones de acci√≥n */
        }
        
        .btn-clear:hover {
            background-color: #5a6268;
        }
        
        /* Bot√≥n de Registrar */
        .btn-register {
            background-color: #dc3545;
            color: white;
            width: 48%;
            margin-top: 0; /* Lo reseteamos para los botones de acci√≥n */
        }

        .btn-register:hover {
            background-color: #c82333;
        }
        
        /* Bot√≥n de Registro Deshabilitado */
        .btn-register:disabled {
            background-color: #e0e0e0;
            color: #a0a0a0;
            cursor: not-allowed;
            transform: none;
        }

        /* Contenedor de botones de Limpiar/Registrar */
        .form-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 25px;
            margin-bottom: 5px; /* Ajustado para dejar espacio con el nuevo bot√≥n */
        }
        
        /* Bot√≥n Ver Lista de Turistas */
        .btn-list {
            background-color: #17a2b8;
            color: white;
            margin-top: 15px; /* Deja espacio si va debajo de otro bot√≥n */
            width: 100%;
        }

        .btn-list:hover {
            background-color: #138496;
        }

        /* Estilo para el nuevo bot√≥n del carrusel */
        .btn-carousel {
            background-color: #007bff; /* Un color azul llamativo, por ejemplo */
            color: white;
            width: 100%;
            margin-bottom: 15px; /* Espacio antes del bot√≥n de lista */
            font-size: 1.2rem;
        }

        .btn-carousel:hover {
            background-color: #0056b3;
        }

        /* Botones flotantes (top-right-buttons) */
        .top-right-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .top-right-buttons .btn-register-user,
        .top-right-buttons .btn-logout {
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            width: auto;
        }
        
        .top-right-buttons .btn-register-user {
            background-color: #28a745;
        }

        .top-right-buttons .btn-logout {
            background-color: #dc3545;
        }
        
        .top-right-buttons .btn-register-user:hover {
            background-color: #218838;
        }

        .top-right-buttons .btn-logout:hover {
            background-color: #c82333;
        }

        /* Mensajes de error/√©xito */
        .message-box {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            text-align: center;
            display: none;
            border: 1px solid transparent;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        /* Estilo para mostrar el ID de usuario */
        #userIdDisplay {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #000;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 2;
            white-space: nowrap;
        }
        
    </style>
</head>

<body>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug'); // Habilitar logs para depuraci√≥n

        // ----------------------------------------------------------------------------------
        // CONFIGURACI√ìN DE FIREBASE (Asegurando robustez en el entorno Canvas/GitHub)
        // ----------------------------------------------------------------------------------
        const appId = (typeof __app_id !== 'undefined' && __app_id) ? String(__app_id) : 'github-pages-default-id';
        
        // Configuraci√≥n de Firebase local/fallback (Aseg√∫rate de que este sea el proyecto 'Prueba')
        const LOCAL_FIREBASE_CONFIG = {
             apiKey: "AIzaSyBifMbYtOkxsijnaKlTtl_S_A5dkzE32BM", 
             authDomain: "prueba-ff7bb.firebaseapp.com",
             projectId: "prueba-ff7bb", 
             storageBucket: "prueba-ff7bb.appspot.com",
             messagingSenderId: "700600586061",
             appId: "1:700600586061:web:f1bfae76ae2ff3ed1db104"
        }; 

        // Usamos la configuraci√≥n de Canvas si est√° disponible y es v√°lida, sino usamos el fallback
        const firebaseConfig = typeof __firebase_config !== 'undefined' && JSON.parse(__firebase_config).projectId 
                               ? JSON.parse(__firebase_config) 
                               : LOCAL_FIREBASE_CONFIG;
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // ----------------------------------------------------------------------------------
        // 1. Inicializaci√≥n y Autenticaci√≥n
        // ----------------------------------------------------------------------------------
        try {
            if (!firebaseConfig.projectId) {
                throw new Error("La configuraci√≥n de Firebase est√° incompleta. No se pudo obtener projectId.");
            }
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Listener de estado de autenticaci√≥n
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    document.getElementById('userIdDisplay').textContent = `Usuario ID: ${userId} | App ID: ${appId}`;
                    console.log(`Firebase: Usuario autenticado. UID: ${userId}`);
                } else {
                    // Intento de autenticaci√≥n inicial (Custom Token o An√≥nimo)
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Si no hay token personalizado, intentamos an√≥nimo.
                            // Si el usuario cerr√≥ sesi√≥n, esta l√≠nea har√° que se reautentique an√≥nimamente.
                            await signInAnonymously(auth); 
                        }
                    } catch (error) {
                         showMessage("Error al autenticar. Verifica que la Autenticaci√≥n de Firebase est√© activa (An√≥nimo).", false);
                         console.error("Firebase: Error al intentar autenticar:", error);
                    }
                }
            });

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            showMessage(`Error de conexi√≥n: ${error.message}`, false);
        }

        // --- Funciones de Utilidad ---

        function showMessage(message, isSuccess) {
            const container = document.getElementById('messageContainer');
            container.textContent = message;
            container.className = 'message-box';
            
            if (isSuccess) {
                container.classList.add('message-success');
            } else {
                container.classList.add('message-error');
            }
            container.style.display = 'block';
            setTimeout(() => {
                container.style.display = 'none';
            }, 5000);
        }

        function clearForm() {
            document.getElementById('registroForm').reset();
            document.getElementById('messageContainer').style.display = 'none';
            document.getElementById('btnRegistrar').disabled = false;
        }
        
        // --- FUNCI√ìN DE CIERRE DE SESI√ìN ---
        async function cerrarSesion() {
            if (!auth) {
                 showMessage("Autenticaci√≥n no inicializada.", false);
                 return;
            }
            try {
                // 1. Cierra la sesi√≥n activa (an√≥nima o con token)
                await signOut(auth); 
                console.log("Sesi√≥n cerrada con √©xito.");

                // 2. Muestra un mensaje y redirige al login (o a donde sea el punto de entrada)
                showMessage("Sesi√≥n cerrada. Redirigiendo...", true);
                
                // Redirigir al login.html 
                window.location.href = 'index.html'; 

            } catch (error) {
                showMessage(`Error al cerrar sesi√≥n: ${error.message}`, false);
                console.error("Error al cerrar sesi√≥n:", error);
            }
        }


        // ----------------------------------------------------------------------------------
        // 2. L√≥gica de Registro 
        // ----------------------------------------------------------------------------------

        async function registrarTurista() {
            if (!isAuthReady || !userId) {
                showMessage("Autenticaci√≥n no completa. Intenta nuevamente o recarga la p√°gina.", false);
                return;
            }
            if (!db) {
                showMessage("Base de datos no inicializada.", false);
                return;
            }
            
            document.getElementById('btnRegistrar').disabled = true;
            showMessage("Registrando turista...", true);

            const form = document.getElementById('registroForm');
            
            const turistaData = {
                DNI_Carnet: form.DNI_Carnet.value.trim(),
                ApellidoPaterno: form.ApellidoPaterno.value.trim(),
                ApellidoMaterno: form.ApellidoMaterno.value.trim(),
                Nombres: form.Nombres.value.trim(),
                Telefono: form.Telefono.value.trim(),
                Sexo: form.SexoSelect.value,
                PaisOrigen: form.paisOrigenSelect.value, 
                FechaRegistro: new Date().toISOString(), 
                RegistradoPor: userId 
            };

            // Validaci√≥n simple
            if (!turistaData.DNI_Carnet || !turistaData.Nombres || !turistaData.ApellidoPaterno) {
                showMessage("Por favor, complete los campos obligatorios (DNI, Nombres, Apellido Paterno).", false);
                document.getElementById('btnRegistrar').disabled = false;
                return;
            }

            try {
                // RUTA CR√çTICA: artifacts/{appId}/public/data/turistas
                const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'turistas');
                
                await addDoc(colRef, turistaData);

                showMessage("‚úÖ Turista registrado exitosamente.", true);
                clearForm();
                
            } catch (error) {
                console.error("Error al registrar turista en Firestore:", error);
                
                if (error.code === 'permission-denied' || error.message.includes('insufficient permissions')) {
                    showMessage("‚ùå Error al guardar en la base de datos: Missing or insufficient permissions. (Revisa el AppId y las Reglas de Seguridad)", false);
                } else {
                    showMessage(`‚ùå Error de Firestore: ${error.message}`, false);
                }
                
                document.getElementById('btnRegistrar').disabled = false;
            }
        }

        // Asignaci√≥n de eventos al cargar el documento
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btnRegistrar').addEventListener('click', registrarTurista);
            document.getElementById('btnClear').addEventListener('click', clearForm);
            
            // Asignaci√≥n del evento Cerrar Sesi√≥n
            document.getElementById('btnCerrarSesion').addEventListener('click', cerrarSesion);
            
            // NOTA: El bot√≥n del carrusel es un simple enlace (<a>), no requiere JS adicional aqu√≠.
        });

    </script>
    
    <div class="top-right-buttons">
        <button class="btn btn-register-user" disabled>Registrar nuevo usuario</button>
        <button id="btnCerrarSesion" class="btn btn-logout">Cerrar Sesi√≥n</button>
    </div>

    <div class="container-box">
        <h2 class="text-center">¬°BIENVENIDO A LA FICHA DE REGISTRO!</h2>
        
        <div id="messageContainer" class="message-box" style="display: none;">
            </div>

        <form id="registroForm">
            <div class="form-group">
                <label for="DNI_Carnet">D.N.I. o Carnet de Extranjer√≠a</label>
                <input type="text" id="DNI_Carnet" name="DNI_Carnet" class="form-control" placeholder="Ingresar D.N.I." required>
            </div>

            <div class="form-group">
                <label for="ApellidoPaterno">Apellido Paterno</label>
                <input type="text" id="ApellidoPaterno" name="ApellidoPaterno" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="ApellidoMaterno">Apellido Materno</label>
                <input type="text" id="ApellidoMaterno" name="ApellidoMaterno" class="form-control">
            </div>

            <div class="form-group">
                <label for="Nombres">Nombres</label>
                <input type="text" id="Nombres" name="Nombres" class="form-control" required>
            </div>

            <div class="form-group">
                <label for="Telefono">Tel√©fono</label>
                <input type="tel" id="Telefono" name="Telefono" class="form-control">
            </div>

            <div class="form-group">
                <label for="SexoSelect">Sexo</label>
                <select id="SexoSelect" name="SexoSelect" class="form-control">
                    <option value="Masculino">Masculino</option>
                    <option value="Femenino">Femenino</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-group">
                <label for="paisOrigenSelect">Pa√≠s de Origen</label>
                <select id="paisOrigenSelect" name="paisOrigenSelect" class="form-control">
                    <option value="Peru" selected>Per√∫</option>
                    <option value="Colombia">Colombia</option>
                    <option value="Ecuador">Ecuador</option>
                    <option value="Chile">Chile</option>
                    <option value="Venezuela">Venezuela</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Brasil">Brasil</option>
                    <option value="Espa√±a">Espa√±a</option>
                    <option value="EEUU">Estados Unidos</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>

            <div class="form-actions">
                <button type="button" id="btnClear" class="btn btn-clear">Limpiar Campos</button>
                <button type="button" id="btnRegistrar" class="btn btn-register">Registrar Turista</button>
            </div>
            
        </form>
        
        <a href="carrucel.html" class="btn btn-carousel">Men√∫ Carrusel de Escenarios 3D üé†</a>
        
        <a href="lista_turistas.html" class="btn btn-list">Ver Lista de Turistas</a>
    </div>
    
    <div id="userIdDisplay"></div>
</body>
</html>